name: CI - FrontEnd (.NET 8)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    strategy:
      matrix:
        dotnet-version: ['8.0.x']
      fail-fast: false

    env:
      DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
      DOTNET_CLI_TELEMETRY_OPTOUT: true
      BUILD_CONFIGURATION: Release

    steps:
      - name: Build Start Time
        id: build_start
        shell: pwsh
        run: |
          $startTime = Get-Date
          Write-Host "ðŸš€ Inicio del build: $($startTime.ToString('yyyy-MM-dd HH:mm:ss'))" -ForegroundColor Cyan
          echo "START_TIME=$($startTime.ToString('o'))" >> $env:GITHUB_OUTPUT

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ matrix.dotnet-version }}

      #####################################################################
      # Node/NPM condicional (solo si existe package-lock.json)
      #####################################################################
      - name: Setup Node.js (only if package-lock.json exists)
        if: hashFiles('**/package-lock.json') != ''
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install npm dependencies (only if package-lock.json exists)
        if: hashFiles('**/package-lock.json') != ''
        run: npm ci --no-audit --no-fund

      - name: Validate JSON configuration files
        shell: pwsh
        continue-on-error: true
        run: |
          Write-Host "Validando archivos de configuraciÃ³n JSON..."
          $jsonFiles = Get-ChildItem -Path . -Filter "appsettings*.json" -Recurse
          $errors = 0

          foreach ($file in $jsonFiles) {
            Write-Host "Validando: $($file.FullName)"
            try {
              $null = Get-Content $file.FullName -Raw | ConvertFrom-Json
              Write-Host "âœ… $($file.Name) - VÃ¡lido" -ForegroundColor Green
            } catch {
              Write-Host "âŒ $($file.Name) - Error JSON invÃ¡lido" -ForegroundColor Red
              $errors++
            }
          }

          if ($errors -gt 0) {
            Write-Host "âš ï¸ Se encontraron $errors archivo(s) JSON invÃ¡lido(s). (Piloto: no bloquea)" -ForegroundColor Yellow
            exit 0
          } else {
            Write-Host "âœ… Todos los archivos JSON son vÃ¡lidos" -ForegroundColor Green
          }

      #####################################################################
      # Lint JS (safe) + genera reporte eslint-report.txt
      #####################################################################
      - name: JavaScript Linting (safe + report)
        if: hashFiles('**/package-lock.json') != ''
        shell: pwsh
        continue-on-error: true
        run: |
          if (Test-Path "package.json") {
            $pkg = Get-Content "package.json" -Raw | ConvertFrom-Json
            if ($pkg.scripts -and $pkg.scripts.lint) {
              Write-Host "âœ… Ejecutando npm run lint..." -ForegroundColor Green

              # Guardar output en archivo para subirlo como artefacto
              npm run lint 2>&1 | Tee-Object -FilePath eslint-report.txt

              # En piloto no bloqueamos aunque eslint devuelva exit code != 0
              if ($LASTEXITCODE -ne 0) {
                Write-Host "âš ï¸ ESLint terminÃ³ con warnings/errores. (Piloto: no bloquea)" -ForegroundColor Yellow
                exit 0
              }
            } else {
              "No hay script 'lint' en package.json. Se omite lint JS." | Tee-Object -FilePath eslint-report.txt
            }
          } else {
            "No existe package.json. Se omite lint JS." | Tee-Object -FilePath eslint-report.txt
          }

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/packages.lock.json', '**/global.json') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore dependencies
        run: dotnet restore

      - name: Check code formatting
        run: dotnet format FrontendQuickpass.sln --verify-no-changes --verbosity diagnostic
        continue-on-error: true

      - name: Run .NET Code Analysis
        run: dotnet build -c ${{ env.BUILD_CONFIGURATION }} --no-restore /p:EnforceCodeStyleInBuild=true /p:TreatWarningsAsErrors=false
        continue-on-error: true

      - name: Security scan - NuGet packages
        shell: pwsh
        continue-on-error: true
        run: |
          dotnet list package --vulnerable --include-transitive |
            Tee-Object -FilePath vulnerable-packages.txt

          if (Select-String -Path vulnerable-packages.txt -Pattern "vulnerable" -Quiet) {
            Write-Host "âš ï¸ Se detectaron posibles vulnerabilidades (Piloto: no bloquea)." -ForegroundColor Yellow
          } else {
            Write-Host "âœ… No se encontraron vulnerabilidades reportadas" -ForegroundColor Green
          }

      - name: Build (Release)
        run: dotnet build -c ${{ env.BUILD_CONFIGURATION }} --no-restore

      - name: Test with Code Coverage (Release)
        continue-on-error: true
        run: |
          dotnet test -c ${{ env.BUILD_CONFIGURATION }} --no-build --verbosity normal `
            --collect:"XPlat Code Coverage" `
            --results-directory ./coverage

      - name: Generate Code Coverage Report
        if: always()
        shell: pwsh
        continue-on-error: true
        run: |
          if (Test-Path "./coverage") {
            New-Item -ItemType Directory -Force -Path ".tools" | Out-Null
            dotnet tool install --tool-path ./.tools dotnet-reportgenerator-globaltool

            ./.tools/reportgenerator `
              "-reports:./coverage/**/coverage.cobertura.xml" `
              "-targetdir:./coverage-report" `
              "-reporttypes:Html;TextSummary"

            if (Test-Path "./coverage-report/Summary.txt") {
              Write-Host "`nðŸ“Š Resumen de Code Coverage:" -ForegroundColor Cyan
              Get-Content "./coverage-report/Summary.txt"
            }
          } else {
            Write-Host "âš ï¸ No se generÃ³ cobertura (sin tests o sin collector)" -ForegroundColor Yellow
          }

      - name: Analyze Static Assets Size
        shell: pwsh
        continue-on-error: true
        run: |
          Write-Host "`nðŸ“¦ AnÃ¡lisis de tamaÃ±o de assets estÃ¡ticos:" -ForegroundColor Cyan

          if (Test-Path "wwwroot/js") {
            Write-Host "`nArchivos JavaScript (wwwroot/js):" -ForegroundColor Yellow
            $jsFiles = Get-ChildItem -Path "wwwroot/js" -Filter "*.js" -Recurse |
              Where-Object { $_.Length -gt 50KB } |
              Sort-Object Length -Descending |
              Select-Object -First 10

            if ($jsFiles) {
              $jsFiles | ForEach-Object {
                $sizeKB = [math]::Round($_.Length / 1KB, 2)
                Write-Host "  - $($_.Name): $sizeKB KB"
              }
            } else {
              Write-Host "  âœ… Todos los archivos JS son menores a 50KB" -ForegroundColor Green
            }
          }

          if (Test-Path "wwwroot/css") {
            Write-Host "`nArchivos CSS (wwwroot/css):" -ForegroundColor Yellow
            $cssFiles = Get-ChildItem -Path "wwwroot/css" -Filter "*.css" -Recurse |
              Where-Object { $_.Length -gt 50KB } |
              Sort-Object Length -Descending |
              Select-Object -First 10

            if ($cssFiles) {
              $cssFiles | ForEach-Object {
                $sizeKB = [math]::Round($_.Length / 1KB, 2)
                Write-Host "  - $($_.Name): $sizeKB KB"
              }
            } else {
              Write-Host "  âœ… Todos los archivos CSS son menores a 50KB" -ForegroundColor Green
            }
          }

          if (Test-Path "wwwroot") {
            $wwwrootSize = (Get-ChildItem -Path "wwwroot" -Recurse | Measure-Object -Property Length -Sum).Sum
            $wwwrootSizeMB = [math]::Round($wwwrootSize / 1MB, 2)
            Write-Host "`nTamaÃ±o total de wwwroot: $wwwrootSizeMB MB"
          }

      - name: Publish (Release)
        run: dotnet publish -c ${{ env.BUILD_CONFIGURATION }} -o publish --no-build

      - name: Zip publish output
        run: |
          powershell Compress-Archive -Path publish\* -DestinationPath frontend_publish.zip -Force

      - name: Upload artifact (publish zip)
        uses: actions/upload-artifact@v4
        with:
          name: frontend_publish
          path: frontend_publish.zip
          retention-days: 14

      - name: Upload security scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-results
          path: vulnerable-packages.txt
          retention-days: 7

      - name: Upload code coverage report
        if: always()
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: code-coverage-report
          path: coverage-report/
          retention-days: 14

      - name: Upload ESLint report
        if: always()
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: eslint-report
          path: eslint-report.txt
          retention-days: 14

      - name: Build Performance Analysis
        if: always()
        shell: pwsh
        run: |
          $endTime = Get-Date
          $startTime = [DateTime]::Parse("${{ steps.build_start.outputs.START_TIME }}")
          $duration = $endTime - $startTime

          Write-Host "`nâ±ï¸ ANÃLISIS DE RENDIMIENTO DEL BUILD" -ForegroundColor Cyan
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Cyan
          Write-Host "Inicio:   $($startTime.ToString('HH:mm:ss'))" -ForegroundColor White
          Write-Host "Fin:      $($endTime.ToString('HH:mm:ss'))" -ForegroundColor White
          Write-Host "DuraciÃ³n: $([int]$duration.TotalMinutes) min $($duration.Seconds) seg" -ForegroundColor $(if($duration.TotalMinutes -gt 10){"Red"}elseif($duration.TotalMinutes -gt 5){"Yellow"}else{"Green"})
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Cyan

      - name: Pipeline Summary (Console)
        if: always()
        shell: pwsh
        run: |
          Write-Host "`nðŸ“‹ RESUMEN DEL PIPELINE CI/CD" -ForegroundColor Cyan
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan

          Write-Host "`nðŸ”§ CONFIGURACIÃ“N:" -ForegroundColor Yellow
          Write-Host "  â€¢ .NET Version: ${{ matrix.dotnet-version }}"
          Write-Host "  â€¢ Node.js Version: 20"
          Write-Host "  â€¢ Runner: ${{ runner.os }}"
          Write-Host "  â€¢ ConfiguraciÃ³n: ${{ env.BUILD_CONFIGURATION }}"

          Write-Host "`nðŸ“¦ ARTEFACTOS GENERADOS:" -ForegroundColor Yellow
          Write-Host "  â€¢ frontend_publish.zip (14 dÃ­as de retenciÃ³n)"
          Write-Host "  â€¢ security-scan-results (7 dÃ­as de retenciÃ³n)"
          Write-Host "  â€¢ code-coverage-report (14 dÃ­as de retenciÃ³n)"
          Write-Host "  â€¢ eslint-report.txt (14 dÃ­as de retenciÃ³n)"

          Write-Host "`nâœ… VALIDACIONES EJECUTADAS:" -ForegroundColor Yellow
          Write-Host "  âœ“ ValidaciÃ³n de formato de cÃ³digo (dotnet format)"
          Write-Host "  âœ“ AnÃ¡lisis estÃ¡tico de cÃ³digo (.NET Analyzers)"
          Write-Host "  âœ“ Escaneo de seguridad (NuGet vulnerabilities)"
          Write-Host "  âœ“ ValidaciÃ³n de archivos JSON (appsettings)"
          Write-Host "  âœ“ Linting de JavaScript (ESLint)"
          Write-Host "  âœ“ AnÃ¡lisis de tamaÃ±o de assets"
          Write-Host "  âœ“ Code coverage report"

          Write-Host "`nðŸ”— INFORMACIÃ“N DEL COMMIT:" -ForegroundColor Yellow
          Write-Host "  â€¢ Branch: ${{ github.ref_name }}"
          Write-Host "  â€¢ Commit: ${{ github.sha }}"
          Write-Host "  â€¢ Autor: ${{ github.actor }}"
          Write-Host "  â€¢ Workflow: ${{ github.workflow }}"
          Write-Host "  â€¢ Run ID: ${{ github.run_id }}"
          Write-Host "  â€¢ Run Number: ${{ github.run_number }}"

          Write-Host "`nðŸŒ LINKS ÃšTILES:" -ForegroundColor Yellow
          Write-Host "  â€¢ Workflow: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          Write-Host "  â€¢ Commit: https://github.com/${{ github.repository }}/commit/${{ github.sha }}"

          Write-Host "`nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          Write-Host "ðŸŽ‰ Pipeline completado exitosamente!" -ForegroundColor Green
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan

      - name: Generate GitHub Job Summary
        if: always()
        shell: pwsh
        run: |
          $summary = @"
          # ðŸŽ¯ Pipeline CI/CD - FrontEnd (.NET 8)

          ## âœ… Build Completado

          ### ðŸ”§ ConfiguraciÃ³n del Build
          | Componente | VersiÃ³n/Valor |
          |-----------|---------------|
          | .NET SDK | ${{ matrix.dotnet-version }} |
          | Node.js | 20 |
          | Sistema Operativo | ${{ runner.os }} |
          | ConfiguraciÃ³n | ${{ env.BUILD_CONFIGURATION }} |

          ### ðŸ“¦ Artefactos Generados
          - âœ… **frontend_publish.zip** - AplicaciÃ³n lista para deploy (14 dÃ­as)
          - âœ… **security-scan-results** - Reporte de seguridad NuGet (7 dÃ­as)
          - âœ… **code-coverage-report** - Reporte de cobertura de cÃ³digo (14 dÃ­as)
          - âœ… **eslint-report.txt** - Reporte de linting JavaScript (14 dÃ­as)

          ### ðŸ” Validaciones Ejecutadas (Modo Piloto)
          - âœ… ValidaciÃ³n de formato de cÃ³digo (dotnet format)
          - âœ… AnÃ¡lisis estÃ¡tico de cÃ³digo (.NET Analyzers)
          - âœ… Escaneo de seguridad (NuGet vulnerabilities)
          - âœ… ValidaciÃ³n de archivos JSON (appsettings)
          - âœ… Linting de JavaScript (ESLint)
          - âœ… AnÃ¡lisis de tamaÃ±o de assets estÃ¡ticos
          - âœ… Code Coverage Report

          > **Nota:** Todas las validaciones estÃ¡n en modo "piloto" (no bloquean el build).
          > Revisa los reportes para identificar Ã¡reas de mejora.

          ### ðŸ”— InformaciÃ³n del Build
          - **Branch:** ${{ github.ref_name }}
          - **Commit:** [\`${{ github.sha }}\`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
          - **Autor:** ${{ github.actor }}
          - **Workflow Run:** [#${{ github.run_number }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ### ðŸ“Š PrÃ³ximos Pasos
          1. **Descarga los artefactos** desde la pestaÃ±a "Summary" arriba
          2. **Revisa eslint-report.txt** para ver warnings de JavaScript
          3. **Verifica security-scan-results** para vulnerabilidades en paquetes NuGet
          4. **Revisa code-coverage-report** cuando agregues tests unitarios
          5. **Deploy frontend_publish.zip** a tu servidor IIS

          ---
          **ðŸŽ‰ Pipeline ejecutado exitosamente!** | Tiempo total: Ver "Build Performance Analysis" arriba
          "@

          $summary | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8
