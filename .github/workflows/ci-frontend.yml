# Nombre que verÃ¡s en la pestaÃ±a Actions de GitHub
name: CI - FrontEnd (.NET 8)

# CuÃ¡ndo se ejecuta este workflow
on:
  # Cada push a la rama main (para la prueba)
  push:
    branches: [ "main" ]

  # TambiÃ©n en pull requests a main
  pull_request:
    branches: [ "main" ]

  # Permite ejecutarlo manualmente desde la pestaÃ±a Actions
  workflow_dispatch:

jobs:
  # Job principal: compila, prueba, publica y genera artefacto
  build:
    # Runner donde se ejecuta (Windows porque usaremos PowerShell para zip fÃ¡cilmente)
    runs-on: windows-latest

    # Estrategia de matriz para probar en mÃºltiples configuraciones
    strategy:
      matrix:
        dotnet-version: ['8.0.x']
        # Puedes descomentar la siguiente lÃ­nea para probar en mÃºltiples versiones:
        # dotnet-version: ['8.0.x', '9.0.x']
      fail-fast: false  # ContinÃºa con otras versiones aunque una falle

    # Variables de entorno para el job
    env:
      DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
      DOTNET_CLI_TELEMETRY_OPTOUT: true
      BUILD_CONFIGURATION: Release

    steps:
      # 0) Registrar inicio del build
      - name: Build Start Time
        id: build_start
        run: |
          $startTime = Get-Date
          Write-Host "ğŸš€ Inicio del build: $($startTime.ToString('yyyy-MM-dd HH:mm:ss'))" -ForegroundColor Cyan
          echo "START_TIME=$($startTime.ToString('o'))" >> $env:GITHUB_OUTPUT
        shell: pwsh
      # 1) Descarga el cÃ³digo del repo al runner
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2) Instala/configura el SDK de .NET (usa la versiÃ³n de la matriz)
      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ matrix.dotnet-version }}

      # 3) Instala Node.js para dependencias npm (Chart.js)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # 4) Instala dependencias npm
      - name: Install npm dependencies
        run: npm ci

      # 4.5) ValidaciÃ³n de archivos JSON de configuraciÃ³n
      - name: Validate JSON configuration files
        run: |
          Write-Host "Validando archivos de configuraciÃ³n JSON..."
          $jsonFiles = Get-ChildItem -Path . -Filter "appsettings*.json" -Recurse
          $errors = 0
          foreach ($file in $jsonFiles) {
            Write-Host "Validando: $($file.FullName)"
            try {
              $content = Get-Content $file.FullName -Raw | ConvertFrom-Json
              Write-Host "âœ… $($file.Name) - VÃ¡lido" -ForegroundColor Green
            } catch {
              Write-Host "âŒ $($file.Name) - Error: $_" -ForegroundColor Red
              $errors++
            }
          }
          if ($errors -gt 0) {
            Write-Host "âš ï¸ Se encontraron $errors archivo(s) JSON invÃ¡lido(s)" -ForegroundColor Yellow
            exit 0
          } else {
            Write-Host "âœ… Todos los archivos JSON son vÃ¡lidos" -ForegroundColor Green
          }
        shell: pwsh
        continue-on-error: true

      # 4.6) Linting de JavaScript con ESLint (instalaciÃ³n bÃ¡sica)
      - name: JavaScript Linting
        run: |
          Write-Host "Instalando ESLint..."
          npm install --save-dev eslint@latest

          Write-Host "Inicializando configuraciÃ³n bÃ¡sica de ESLint..."
          $eslintConfig = @"
          {
            "env": {
              "browser": true,
              "es2021": true
            },
            "extends": "eslint:recommended",
            "parserOptions": {
              "ecmaVersion": "latest",
              "sourceType": "script"
            },
            "rules": {
              "no-unused-vars": "warn",
              "no-console": "off"
            }
          }
          "@
          Set-Content -Path ".eslintrc.json" -Value $eslintConfig

          Write-Host "Ejecutando ESLint en archivos JavaScript..."
          npx eslint "wwwroot/js/**/*.js" --max-warnings=50 || Write-Host "âš ï¸ Se encontraron advertencias de ESLint" -ForegroundColor Yellow
        shell: pwsh
        continue-on-error: true

      # 5) Cache de NuGet: acelera restores posteriores
      #    (Si cambian dependencias, la cache se invalida automÃ¡ticamente)
      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/packages.lock.json', '**/global.json') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      # 6) Restaura dependencias .NET
      - name: Restore dependencies
        run: dotnet restore

      # 7) ValidaciÃ³n de formato de cÃ³digo (dotnet format)
      - name: Check code formatting
        run: dotnet format --verify-no-changes --verbosity diagnostic
        continue-on-error: true

      # 8) AnÃ¡lisis de cÃ³digo con .NET Analyzers
      - name: Run .NET Code Analysis
        run: dotnet build -c Release --no-restore /p:EnforceCodeStyleInBuild=true /p:TreatWarningsAsErrors=false
        continue-on-error: true

      # 9) Escaneo de seguridad - Vulnerabilidades en paquetes NuGet
      - name: Security scan - NuGet packages
        run: |
          dotnet list package --vulnerable --include-transitive 2>&1 | tee vulnerable-packages.txt
          if (Select-String -Path vulnerable-packages.txt -Pattern "has the following vulnerable packages" -Quiet) {
            Write-Host "âš ï¸ Vulnerabilidades encontradas en paquetes NuGet"
            Get-Content vulnerable-packages.txt
            exit 0
          } else {
            Write-Host "âœ… No se encontraron vulnerabilidades en paquetes NuGet"
          }
        shell: pwsh
        continue-on-error: true

      # 10) Compila en Release
      - name: Build (Release)
        run: dotnet build -c Release --no-restore

      # 11) Ejecuta pruebas con code coverage (continÃºa aunque no haya tests)
      - name: Test with Code Coverage (Release)
        run: |
          dotnet test -c Release --no-build --verbosity normal `
            --collect:"XPlat Code Coverage" `
            --results-directory ./coverage
        continue-on-error: true

      # 11.5) Genera reporte de code coverage
      - name: Generate Code Coverage Report
        if: always()
        run: |
          dotnet tool install -g dotnet-reportgenerator-globaltool
          if (Test-Path "./coverage") {
            reportgenerator `
              "-reports:./coverage/**/coverage.cobertura.xml" `
              "-targetdir:./coverage-report" `
              "-reporttypes:Html;TextSummary"

            if (Test-Path "./coverage-report/Summary.txt") {
              Write-Host "`nğŸ“Š Resumen de Code Coverage:" -ForegroundColor Cyan
              Get-Content "./coverage-report/Summary.txt"
            }
          } else {
            Write-Host "âš ï¸ No se generÃ³ cobertura de cÃ³digo (sin tests)" -ForegroundColor Yellow
          }
        shell: pwsh
        continue-on-error: true

      # 11.6) AnÃ¡lisis de tamaÃ±o de assets estÃ¡ticos
      - name: Analyze Static Assets Size
        run: |
          Write-Host "`nğŸ“¦ AnÃ¡lisis de tamaÃ±o de assets estÃ¡ticos:" -ForegroundColor Cyan

          # Analizar archivos JavaScript
          Write-Host "`nArchivos JavaScript (wwwroot/js):" -ForegroundColor Yellow
          $jsFiles = Get-ChildItem -Path "wwwroot/js" -Filter "*.js" -Recurse |
            Where-Object { $_.Length -gt 50KB } |
            Sort-Object Length -Descending |
            Select-Object -First 10

          if ($jsFiles) {
            $jsFiles | ForEach-Object {
              $sizeKB = [math]::Round($_.Length / 1KB, 2)
              Write-Host "  - $($_.Name): $sizeKB KB" -ForegroundColor $(if($sizeKB -gt 100){"Red"}else{"White"})
            }
          } else {
            Write-Host "  âœ… Todos los archivos JS son menores a 50KB" -ForegroundColor Green
          }

          # Analizar archivos CSS
          Write-Host "`nArchivos CSS (wwwroot/css):" -ForegroundColor Yellow
          $cssFiles = Get-ChildItem -Path "wwwroot/css" -Filter "*.css" -Recurse |
            Where-Object { $_.Length -gt 50KB } |
            Sort-Object Length -Descending |
            Select-Object -First 10

          if ($cssFiles) {
            $cssFiles | ForEach-Object {
              $sizeKB = [math]::Round($_.Length / 1KB, 2)
              Write-Host "  - $($_.Name): $sizeKB KB" -ForegroundColor $(if($sizeKB -gt 100){"Red"}else{"White"})
            }
          } else {
            Write-Host "  âœ… Todos los archivos CSS son menores a 50KB" -ForegroundColor Green
          }

          # TamaÃ±o total de wwwroot
          $wwwrootSize = (Get-ChildItem -Path "wwwroot" -Recurse | Measure-Object -Property Length -Sum).Sum
          $wwwrootSizeMB = [math]::Round($wwwrootSize / 1MB, 2)
          Write-Host "`nTamaÃ±o total de wwwroot: $wwwrootSizeMB MB" -ForegroundColor $(if($wwwrootSizeMB -gt 50){"Red"}elseif($wwwrootSizeMB -gt 20){"Yellow"}else{"Green"})
        shell: pwsh
        continue-on-error: true

      # 12) Publica el proyecto (genera la carpeta lista para desplegar en IIS)
      - name: Publish (Release)
        run: dotnet publish -c Release -o publish --no-build

      # 13) Empaqueta la salida de publish en un ZIP (artefacto)
      - name: Zip publish output
        run: |
          powershell Compress-Archive -Path publish\* -DestinationPath frontend_publish.zip -Force

      # 14) Sube el ZIP como "Artifact" del run (NO se guarda en el repo)
      #     Se descarga desde Actions -> run -> Artifacts
      - name: Upload artifact (publish zip)
        uses: actions/upload-artifact@v4
        with:
          name: frontend_publish
          path: frontend_publish.zip
          retention-days: 14

      # 15) Sube reporte de vulnerabilidades como artefacto
      - name: Upload security scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-results
          path: vulnerable-packages.txt
          retention-days: 7

      # 16) Sube reporte de code coverage como artefacto
      - name: Upload code coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-coverage-report
          path: coverage-report/
          retention-days: 14
        continue-on-error: true

      # 17) AnÃ¡lisis de rendimiento del build
      - name: Build Performance Analysis
        if: always()
        run: |
          $endTime = Get-Date
          $startTime = [DateTime]::Parse("${{ steps.build_start.outputs.START_TIME }}")
          $duration = $endTime - $startTime

          Write-Host "`nâ±ï¸ ANÃLISIS DE RENDIMIENTO DEL BUILD" -ForegroundColor Cyan
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Cyan
          Write-Host "Inicio:   $($startTime.ToString('HH:mm:ss'))" -ForegroundColor White
          Write-Host "Fin:      $($endTime.ToString('HH:mm:ss'))" -ForegroundColor White
          Write-Host "DuraciÃ³n: $([int]$duration.TotalMinutes) min $($duration.Seconds) seg" -ForegroundColor $(if($duration.TotalMinutes -gt 10){"Red"}elseif($duration.TotalMinutes -gt 5){"Yellow"}else{"Green"})
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Cyan
        shell: pwsh

      # 18) Resumen final del pipeline en consola
      - name: Pipeline Summary (Console)
        if: always()
        run: |
          Write-Host "`nğŸ“‹ RESUMEN DEL PIPELINE CI/CD" -ForegroundColor Cyan
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan

          Write-Host "`nğŸ”§ CONFIGURACIÃ“N:" -ForegroundColor Yellow
          Write-Host "  â€¢ .NET Version: ${{ matrix.dotnet-version }}"
          Write-Host "  â€¢ Node.js Version: 20"
          Write-Host "  â€¢ Runner: ${{ runner.os }}"
          Write-Host "  â€¢ ConfiguraciÃ³n: ${{ env.BUILD_CONFIGURATION }}"

          Write-Host "`nğŸ“¦ ARTEFACTOS GENERADOS:" -ForegroundColor Yellow
          Write-Host "  â€¢ frontend_publish.zip (14 dÃ­as de retenciÃ³n)"
          Write-Host "  â€¢ security-scan-results (7 dÃ­as de retenciÃ³n)"
          Write-Host "  â€¢ code-coverage-report (14 dÃ­as de retenciÃ³n)"

          Write-Host "`nâœ… VALIDACIONES EJECUTADAS:" -ForegroundColor Yellow
          Write-Host "  âœ“ ValidaciÃ³n de formato de cÃ³digo (dotnet format)"
          Write-Host "  âœ“ AnÃ¡lisis estÃ¡tico de cÃ³digo (.NET Analyzers)"
          Write-Host "  âœ“ Escaneo de seguridad (NuGet vulnerabilities)"
          Write-Host "  âœ“ ValidaciÃ³n de archivos JSON"
          Write-Host "  âœ“ Linting de JavaScript (ESLint)"
          Write-Host "  âœ“ AnÃ¡lisis de tamaÃ±o de assets"
          Write-Host "  âœ“ Code coverage report"

          Write-Host "`nğŸ”— INFORMACIÃ“N DEL COMMIT:" -ForegroundColor Yellow
          Write-Host "  â€¢ Branch: ${{ github.ref_name }}"
          Write-Host "  â€¢ Commit: ${{ github.sha }}"
          Write-Host "  â€¢ Autor: ${{ github.actor }}"
          Write-Host "  â€¢ Workflow: ${{ github.workflow }}"
          Write-Host "  â€¢ Run ID: ${{ github.run_id }}"
          Write-Host "  â€¢ Run Number: ${{ github.run_number }}"

          Write-Host "`nğŸŒ LINKS ÃšTILES:" -ForegroundColor Yellow
          Write-Host "  â€¢ Workflow: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          Write-Host "  â€¢ Commit: https://github.com/${{ github.repository }}/commit/${{ github.sha }}"

          Write-Host "`nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          Write-Host "ğŸ‰ Pipeline completado exitosamente!" -ForegroundColor Green
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
        shell: pwsh

      # 19) Generar resumen en GitHub Summary (visible en la pestaÃ±a Summary)
      - name: Generate GitHub Job Summary
        if: always()
        run: |
          $summary = @"
          # ğŸ¯ Pipeline CI/CD - FrontEnd (.NET 8)

          ## âœ… Build Completado

          ### ğŸ”§ ConfiguraciÃ³n del Build
          | Componente | VersiÃ³n/Valor |
          |-----------|---------------|
          | .NET SDK | ${{ matrix.dotnet-version }} |
          | Node.js | 20 |
          | Sistema Operativo | ${{ runner.os }} |
          | ConfiguraciÃ³n | ${{ env.BUILD_CONFIGURATION }} |

          ### ğŸ“¦ Artefactos Generados
          - âœ… **frontend_publish.zip** - AplicaciÃ³n lista para deploy (14 dÃ­as)
          - âœ… **security-scan-results** - Reporte de seguridad (7 dÃ­as)
          - âœ… **code-coverage-report** - Reporte de cobertura (14 dÃ­as)

          ### ğŸ” Validaciones Ejecutadas
          - âœ… ValidaciÃ³n de formato de cÃ³digo (dotnet format)
          - âœ… AnÃ¡lisis estÃ¡tico de cÃ³digo (.NET Analyzers)
          - âœ… Escaneo de seguridad (NuGet vulnerabilities)
          - âœ… ValidaciÃ³n de archivos JSON (appsettings)
          - âœ… Linting de JavaScript (ESLint)
          - âœ… AnÃ¡lisis de tamaÃ±o de assets estÃ¡ticos
          - âœ… Code Coverage Report

          ### ğŸ”— InformaciÃ³n del Build
          - **Branch:** ${{ github.ref_name }}
          - **Commit:** [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
          - **Autor:** ${{ github.actor }}
          - **Workflow Run:** [${{ github.run_number }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ### ğŸ“Š PrÃ³ximos Pasos
          1. Descarga los artefactos desde la pestaÃ±a "Summary" arriba
          2. Revisa el reporte de seguridad para vulnerabilidades
          3. Verifica el reporte de code coverage cuando agregues tests
          4. Deploy del archivo **frontend_publish.zip** a tu servidor IIS

          ---
          **ğŸ‰ Pipeline ejecutado exitosamente!**
          "@

          $summary | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8
        shell: pwsh


