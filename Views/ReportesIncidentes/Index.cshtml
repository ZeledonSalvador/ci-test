@model List<FrontendQuickpass.Models.PendingReportDto>

@{
    ViewData["Title"] = "Reportes de incidentes";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var pager = ViewBag.Pager as FrontendQuickpass.Models.Pager 
                ?? new FrontendQuickpass.Models.Pager();

    var filters = ViewBag.Filters ?? new { Page = 1, Size = 10, search = "" };

    int currentPage = (int)(filters.GetType().GetProperty("Page")?.GetValue(filters) ?? pager.Page);
    int sizeVal     = (int)(filters.GetType().GetProperty("Size")?.GetValue(filters) ?? pager.Size);
    string search   = (string)(filters.GetType().GetProperty("search")?.GetValue(filters) ?? "");

    var totalPages  = pager.TotalPages > 0 ? pager.TotalPages : 1;

    var pagesToShow = new List<int>();
    void AddP(int p){ if(p>=1 && p<=totalPages && !pagesToShow.Contains(p)) pagesToShow.Add(p); }
    AddP(1); AddP(2);
    for (int p = currentPage - 1; p <= currentPage + 1; p++) AddP(p);
    AddP(totalPages - 1); AddP(totalPages);
    pagesToShow.Sort();
}

@section Styles {
    <link rel="stylesheet" href="~/css/reportes-incidentes.css" />
}

<section class="ri-banner">
    <h1>Reportes de incidentes</h1>
</section>

<div class="container-fluid mt-3">
    <!-- Filtros -->
    <form id="ri-filter-form" method="get" class="ri-filter-form">
        <div class="form-row align-items-end">
            <div class="col-md-6 mb-2">
                <label for="search"><i class="fas fa-search"></i> Buscar</label>
                <input type="text" class="form-control rounded-xl" id="search" name="search" value="@search" placeholder="Motorista, licencia, cliente, codigo...">
            </div>

            <input type="hidden" name="size" value="@sizeVal" />

            <div class="col-md-3 mb-2">
                <button type="submit" class="btn btn-primary btn-block ri-btn-filter rounded-md">
                    <i class="fas fa-filter"></i> Aplicar Filtros
                </button>
            </div>
        </div>
    </form>

    @if (!string.IsNullOrWhiteSpace(ViewBag.Error as string))
    {
        <div class="alert alert-danger mt-3">@ViewBag.Error</div>
    }

    <!-- Grid de tarjetas -->
    <div class="row mt-3" id="ri-cards-container">
        @if (Model != null && Model.Any())
        {
            foreach (var r in Model)
            {
                var cliente   = (r?.Shipment?.Client?.Name ?? "").Replace("_"," ").ToUpper();
                var producto  = (r?.Shipment?.Product ?? "").Replace("_"," ").ToUpper();
                var motorista = (r?.Driver?.Name ?? "").ToUpper();
                var licencia  = (r?.Driver?.License ?? "");
                var evento    = (r?.EventType ?? "").ToUpper();
                var falta     = (r?.FaultType ?? "").ToUpper();
                var lugar     = (r?.EventLocation ?? "").ToUpper();
                var fecha     = r?.ReportDatetime;

                var banner = !string.IsNullOrWhiteSpace(licencia) ? licencia : $"R{r?.Id}";

                var allUrls = r?.ProcessedUrls ?? new List<string>();
                var driverPhoto = r?.DriverPhotoUrl ?? "";
                var evidenceUrls = r?.EvidenceUrlsProcessed ?? new List<string>();
                
                var dataUrls = string.Join("||", allUrls);
                var dataEvidenceUrls = string.Join("||", evidenceUrls);

                var statusHistory = System.Text.Json.JsonSerializer.Serialize(r?.StatusHistory ?? new List<FrontendQuickpass.Models.BlacklistStatusHistory>());

                var canOpenModal = HasAnyRole(Context, "ADMINISTRADOR", "GERENTE_PLANTA");
                var cardClass = canOpenModal ? "ri-card penalty-card-clickable" : "ri-card";

        <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12 mb-4">
            <div class="@cardClass"
                 data-report-id="@r?.Id"
                 data-driver-name="@motorista"
                 data-driver-license="@licencia"
                 data-client="@cliente"
                 data-product="@producto"
                 data-event-type="@evento"
                 data-fault-type="@falta"
                 data-location="@lugar"
                 data-event-date="@(fecha.HasValue ? ToLocal(fecha.Value).ToString("dd/MM/yyyy HH:mm") : "N/D")"
                 data-description="@r?.Description"
                 data-driver-photo="@driverPhoto"
                 data-evidence-urls="@dataEvidenceUrls"
                 data-all-urls="@dataUrls"
                 data-status-history='@Html.Raw(statusHistory.Replace("'", "&apos;"))'
                 style="cursor: pointer;">
                <div class="ri-card-banner">@banner</div>

                <div class="ri-card-body">
                    <p class="ri-field-title"><i class="fas fa-user text-primary"></i> <strong>Motorista:</strong></p>
                    <p class="ri-field-value">@motorista</p>

                    <p class="ri-field-title"><i class="fas fa-flag text-primary"></i> <strong>Cliente:</strong></p>
                    <p class="ri-field-value">@cliente</p>

                    <p class="ri-field-title"><i class="fas fa-boxes text-primary"></i> <strong>Producto:</strong></p>
                    <p class="ri-field-value">@producto</p>

                    <p class="ri-field-title"><i class="fas fa-list-ul text-primary"></i> <strong>Evento:</strong></p>
                    <p class="ri-field-value">@evento</p>

                    <p class="ri-field-title"><i class="fas fa-exclamation-triangle text-primary"></i> <strong>Falta:</strong></p>
                    <p class="ri-field-value">@falta</p>

                    <p class="ri-field-title"><i class="fas fa-map-marker-alt text-primary"></i> <strong>Lugar:</strong></p>
                    <p class="ri-field-value">@lugar</p>

                    <hr class="ri-sep" />

                    <p class="ri-field-title"><i class="far fa-calendar-alt text-primary"></i> <strong>Fecha de evento:</strong></p>
                    <p class="ri-field-value">
                        @(fecha.HasValue ? ToLocal(fecha.Value).ToString("dd/MM/yyyy HH:mm") : "N/D")
                    </p>
                </div>
            </div>
        </div>
            }
        }
        else
        {
            <div class="col-12">
                <div class="alert alert-info">No hay resultados.</div>
            </div>
        }
    </div>

    <!-- Paginación -->
    <div class="ri-pagination-controls">
        @if (totalPages > 1)
        {
            <div class="ri-pagination-row d-flex justify-content-between align-items-center flex-wrap">
                <div class="ri-pagination-spacer"></div>

                <div class="ri-pagination ri-pagination-nav d-flex align-items-center">
                    <a class="page-nav @(currentPage <= 1 ? "disabled" : "")"
                       href="@(currentPage <= 1 ? "javascript:void(0)" : BuildPageUrl(currentPage - 1, sizeVal, search))"
                       title="Anterior" aria-label="Página anterior">
                        <i class="fas fa-angle-left"></i>
                    </a>

                    @for (int i = 0; i < pagesToShow.Count; i++)
                    {
                        var p = pagesToShow[i];
                        var prev = i > 0 ? pagesToShow[i - 1] : (int?)null;
                        if (prev.HasValue && p - prev.Value > 1)
                        {
                            <span class="ellipsis">…</span>
                        }
                        var isCurrent = (p == currentPage);
                        <a class="page-num @(isCurrent ? "current" : "")"
                           href="@(isCurrent ? "javascript:void(0)" : BuildPageUrl(p, sizeVal, search))"
                           aria-current="@(isCurrent ? "page" : null)">@p</a>
                    }

                    <a class="page-nav @(currentPage >= totalPages ? "disabled" : "")"
                       href="@(currentPage >= totalPages ? "javascript:void(0)" : BuildPageUrl(currentPage + 1, sizeVal, search))"
                       title="Siguiente" aria-label="Página siguiente">
                        <i class="fas fa-angle-right"></i>
                    </a>
                </div>

                <div class="ri-page-size-selector d-flex align-items-center">
                    <label for="pageSizeSelect" class="mb-0 mr-2 text-muted small">Registros:</label>
                    <select id="pageSizeSelect" class="form-control form-control-sm">
                        @{
                            int[] sizes = new[] { 10, 20, 30, 50 };
                            foreach (var s in sizes)
                            {
                                <option value="@s" selected="@(sizeVal == s)">@s</option>
                            }
                        }
                    </select>
                </div>
            </div>
        }
        else
        {
            <div class="d-flex justify-content-end">
                <div class="ri-page-size-selector d-flex align-items-center">
                    <label for="pageSizeSelect" class="mb-0 mr-2 text-muted small">Registros:</label>
                    <select id="pageSizeSelect" class="form-control form-control-sm">
                        @{
                            int[] sizes = new[] { 10, 20, 30, 50 };
                            foreach (var s in sizes)
                            {
                                <option value="@s" selected="@(sizeVal == s)">@s</option>
                            }
                        }
                    </select>
                </div>
            </div>
        }
    </div>
</div>

<!-- Modal visor de evidencias -->
<div class="modal fade" id="evidenceModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-md modal-dialog-centered ri-modal-evidence" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Evidencias</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body ri-viewer-body text-center">
        <div id="evidence-viewer-content"></div>
        <div class="ri-file-controls">
            <button type="button" class="btn btn-secondary" id="prev-evidence" title="Anterior">
                <i class="fas fa-chevron-left"></i>
            </button>
            <button type="button" class="btn btn-secondary" id="next-evidence" title="Siguiente">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal para aplicación de amonestación -->
<div class="modal fade" id="penaltyModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-md modal-dialog-centered ri-modal-penalty" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Aplicación de amonestación</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="penalty-content-split">
                    <!-- Información del reporte (lado izquierdo) -->
                    <div class="penalty-info-section">
                        <h6 class="section-title">Información del reporte</h6>

                        <div class="mb-2">
                            <div class="detail-label mb-2">Descripción detallada</div>
                            <div id="penaltyDescription" class="description-box"></div>
                        </div>

                        <div class="mb-2">
                            <div class="detail-label mb-2">Historial de cambios</div>
                            <div id="statusHistory" class="history-box"></div>
                        </div>

                        <!-- Slider de evidencias -->
                        <div class="mb-2">
                            <div class="evidence-slider-header mb-2">
                                <span class="detail-label">Evidencias adjuntas</span>
                                <span id="evidenceCount" class="evidence-count"></span>
                            </div>
                            <div id="evidenceSlider" class="evidence-thumbnails"></div>
                        </div>
                    </div>

                    <!-- Separador naranja -->
                    <div class="penalty-separator"></div>

                    <!-- Formulario de amonestación (lado derecho) -->
                    <div class="penalty-form-section">
                        <h6 class="section-title">Aplicar amonestación</h6>
                        
                        <form id="penaltyForm">
                            @Html.AntiForgeryToken()
                            
                            <input type="hidden" id="penaltyReportId" name="reportId">
                            <input type="hidden" id="penaltyLicense" name="license">

                            <div class="form-group mb-3">
                                <label for="penaltyType" class="form-label">Tipo de amonestación</label>
                                <select class="form-control" id="penaltyType" name="penaltyType" required>
                                    <option value="">Seleccione</option>
                                    <option value="No aplicado">No aplicado</option>
                                    <option value="Temporal">Temporal</option>
                                    <option value="Permanente">Permanente</option>
                                </select>
                            </div>

                            <div class="row mb-3">
                                <div class="col-6">
                                    <label for="penaltyStartDate" class="form-label">Fecha y hora inicio</label>
                                    <input type="datetime-local" class="form-control" id="penaltyStartDate" name="penaltyStartDate" required>
                                </div>
                                <div class="col-6">
                                    <label for="penaltyEndDate" class="form-label">Fecha y hora fin</label>
                                    <input type="datetime-local" class="form-control" id="penaltyEndDate" name="penaltyEndDate">
                                </div>
                            </div>

                            <div class="form-group mb-3">
                                <label for="penaltyObservation" class="form-label">Comentarios</label>
                                <textarea class="form-control" id="penaltyObservation" name="observation" rows="4" 
                                         placeholder="Ingrese sus comentarios..."></textarea>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="confirmPenalty">Confirmar</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        window.API_BASE  = '@(ViewBag.BaseUrl ?? "")';
    </script>
    <script src="~/js/reportes-incidentes.js"></script>
}

@functions{
    public DateTime ToLocal(DateTime utc)
    {
        if (utc.Kind == DateTimeKind.Unspecified)
            utc = DateTime.SpecifyKind(utc, DateTimeKind.Utc);
        return utc.ToLocalTime();
    }

    public string BuildPageUrl(int page, int size, string search)
    {
        var q = System.Web.HttpUtility.ParseQueryString(string.Empty);
        q["page"] = page.ToString();
        q["size"] = size.ToString();
        if (!string.IsNullOrWhiteSpace(search)) q["search"] = search;
        return Url.Action("Index", "ReportesIncidentes") + "?" + q.ToString();
    }
}