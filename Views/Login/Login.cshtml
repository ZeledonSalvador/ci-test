@{
    Layout = "~/Views/Shared/_Login.cshtml";
    ViewData["Title"] = "Login";
}

@section Styles {
    <link rel="stylesheet" href="~/css/login.css" />
}

<body>
    <form asp-controller="Login" asp-action="Index" method="post" id="loginForm">
        <div class="wrapper fadeInDown">
            <div id="formContent" style="border: solid 0px">

                <!-- Usuario -->
                <div class="input-group">
                    <div class="input-group-icon">
                        <img src="~/assets/user-svgrepo-com.svg"
                             alt="Usuario" width="30" height="30" style="filter: invert(100%);" />
                    </div>
                    <input type="text" class="form-control" placeholder="Usuario" name="Usuario" id="Usuario" />
                </div>

                <!-- Contrase√±a -->
                <div class="input-group">
                    <div class="input-group-icon">
                        <img src="~/assets/key-svgrepo-com.svg"
                             alt="Contrase√±a" width="30" height="30" />
                    </div>
                    <input type="password" class="form-control" placeholder="Contrase√±a" name="Clave" id="Clave"
                           autocomplete="off" />
                </div>

                <!-- B√°scula -->
                <div class="input-group">
                    <div class="input-group-icon">
                        <img src="~/assets/industrial-scales-svgrepo-com.svg"
                             alt="B√°scula" width="30" height="30" style="filter: invert(100%)" />
                    </div>
                    <select name="Bascula" id="Bascula" class="form-control" style="height: 60px; color: #646C72; font-weight: normal;">
                        <option value="0">-Seleccione la B√°scula-</option>
                        <option value="1">B√°scula 1</option>
                        <option value="2">B√°scula 2</option>
                        <option value="3">B√°scula 3</option>
                        <option value="4">B√°scula 4</option>
                        <option value="5">B√°scula 5</option>
                        <option value="6">B√°scula 6</option>
                    </select>
                </div>

                <!-- Turno -->
                <div class="input-group">
                    <div class="input-group-icon">
                        <img src="~/assets/time-svgrepo-com.svg"
                             alt="Turno" width="30" height="30" style="filter: invert(100%);" />
                    </div>
                    <select name="Turno" id="Turno" class="form-control" style="height: 60px; color: #646C72; font-weight: normal;">
                        <option value="0">-Seleccione un Turno-</option>
                        <option value="1">6:00 a 14:00</option>
                        <option value="2">14:00 a 22:00</option>
                        <option value="3">22:00 a 6:00</option>
                    </select>
                </div>

                <!-- Bot√≥n Login -->
                <button type="submit" class="fadeIn mt-4"
                        style="animation: fadeIn 1s ease-out forwards;
                               background-color: white; color: #333; font-size: 16px;
                               font-weight: bold; padding: 12px 40px; border-radius: 8px;
                               border: none; cursor: pointer; transition: background-color 0.3s ease;
                               width: 40%; margin: 0 auto;"
                        onmouseover="this.style.backgroundColor='#f1f1f1';"
                        onmouseout="this.style.backgroundColor='white';">
                    LOGIN
                </button>
            </div>
        </div>
    </form>
</body>

@section Scripts {
    <script>
        $(document).ready(function() {
            console.log('üöÄ Inicializando p√°gina de login...');


            window.AlmapacUtils.hideSpinner();

            // ===== MANEJO DE MENSAJES DESDE TEMPDATA =====

            // Mostrar mensaje de cierre de sesi√≥n (info)
            @if (TempData["MensajeInfo"] != null)
            {
                <text>
                Swal.fire({
                    icon: 'info',
                    title: 'Sesi√≥n cerrada',
                    text: @Json.Serialize(TempData["MensajeInfo"]),
                    confirmButtonText: 'Entendido'
                });
                </text>
            }
            
            // Mostrar mensajes de error desde TempData
            @if (TempData["MensajeError"] != null)
            {
                <text>
                Swal.fire({
                    icon: 'error',
                    title: 'Error de autenticaci√≥n',
                    text: @Json.Serialize(TempData["MensajeError"]),
                    confirmButtonText: 'Entendido'
                });
                </text>
            }
            
            // Mostrar mensajes de advertencia desde TempData
            @if (TempData["MensajeWarning"] != null)
            {
                <text>
                Swal.fire({
                    icon: 'warning',
                    title: 'Advertencia',
                    text: @Json.Serialize(TempData["MensajeWarning"]),
                    confirmButtonText: 'Entendido'
                });
                </text>
            }
            
            // ===== COMPATIBILIDAD CON PAR√ÅMETROS URL (LEGACY) =====
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get("error") === "1") {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'La contrase√±a es incorrecta.',
                    confirmButtonText: 'Entendido'
                });
            } else if (urlParams.get("error") === "2") {
                Swal.fire({
                    icon: 'warning',
                    title: 'Campos vac√≠os',
                    text: 'Por favor, complete todos los campos.',
                    confirmButtonText: 'Entendido'
                });
            }
            
            // ===== VALIDACI√ìN Y ENV√çO DEL FORMULARIO =====
            $("#loginForm").submit(function(e) {
                return procesarLogin(e);
            });
            
            // ===== ACTIVAR LOGIN CON ENTER EN TODOS LOS CAMPOS =====
            $('#Usuario, #Clave, #Bascula, #Turno').on('keypress', function(e) {
                if (e.which === 13) {
                    e.preventDefault();
                    procesarLogin(e);
                }
            });
            
            // ===== FOCUS AUTOM√ÅTICO =====
            $("#Usuario").focus();
            
            // ===== CONFIGURAR TOGGLE DE CONTRASE√ëA =====
            setupPasswordToggle();
        });
        
        // ===== FUNCI√ìN CENTRALIZADA PARA PROCESAR EL LOGIN =====
        function procesarLogin(e) {
            var usuario  = $("#Usuario").val().trim();
            var clave    = $("#Clave").val().trim();
            var bascula  = $("#Bascula").val();
            var turno    = $("#Turno").val();
            
            console.log('üîê Validando campos de login...');
            
            // VALIDACI√ìN DE CAMPOS OBLIGATORIOS
            if (!usuario || !clave || bascula === "0" || turno === "0") {
                if (e) e.preventDefault();
                Swal.fire({
                    icon: 'warning',
                    title: 'Campos incompletos',
                    text: 'Debe completar todos los campos para continuar.',
                    confirmButtonColor: '#ffc107',
                    confirmButtonText: 'Entendido'
                });
                
                // Focus en el primer campo vac√≠o
                if (!usuario) $("#Usuario").focus();
                else if (!clave) $("#Clave").focus();
                else if (bascula === "0") $("#Bascula").focus();
                else if (turno === "0") $("#Turno").focus();
                
                return false;
            }
            
            console.log('‚úÖ Campos validados correctamente, enviando formulario...');
            // PERMITIR ENV√çO DEL FORMULARIO
            return true;
        }
        
        // ===== CONFIGURAR TOGGLE DE CONTRASE√ëA =====
        function setupPasswordToggle() {
            const togglePassword = $(`
                <button type="button" class="toggle-password" 
                        style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); 
                               background: transparent; border: none; color: #fff; cursor: pointer; 
                               z-index: 10; outline: none;">
                    <i class="fas fa-eye"></i>
                </button>
            `);
            
            const passwordField = $("#Clave");
            if (passwordField.length) {
                passwordField.parent().css('position', 'relative');
                passwordField.parent().append(togglePassword);
                
                togglePassword.on('click', function() {
                    const type = passwordField.attr('type') === 'password' ? 'text' : 'password';
                    passwordField.attr('type', type);
                    
                    // Cambiar el √≠cono
                    const icon = type === 'password' ? 'fa-eye' : 'fa-eye-slash';
                    $(this).html(`<i class="fas ${icon}"></i>`);
                    
                    // Mantener el focus en el campo de contrase√±a
                    passwordField.focus();
                });
            }
        }

        // Limpiar sessionStorage al cargar la p√°gina de login (cierre de sesi√≥n)
        console.log('Limpiando sessionStorage en p√°gina de login...');
        sessionStorage.clear();
        console.log('‚úÖ SessionStorage limpiado completamente');
    </script>
}
