@model FrontendQuickpass.Models.ListaComprobanteViewModel

@{
    ViewData["Title"] = "Lista de comprobantes";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var pager = ViewBag.Pager as FrontendQuickpass.Models.Pager
        ?? new FrontendQuickpass.Models.Pager();

    var filters = ViewBag.Filters ?? new { Page = 1, Size = 10, search = "" };
    var returnParams = ViewBag.ReturnParams ?? new { ReturnPage = 1, ReturnSize = 10, ReturnSearch = "" };

    int currentPage = (int)(filters.GetType().GetProperty("Page")?.GetValue(filters) ?? pager.Page);
    if (currentPage <= 0) currentPage = 1;

    int sizeVal = (int)(filters.GetType().GetProperty("Size")?.GetValue(filters) ?? pager.Size);
    if (sizeVal <= 0) sizeVal = 10;

    string search = (string)(filters.GetType().GetProperty("search")?.GetValue(filters) ?? "");

    int returnPage = (int)(returnParams.GetType().GetProperty("ReturnPage")?.GetValue(returnParams) ?? 1);
    int returnSize = (int)(returnParams.GetType().GetProperty("ReturnSize")?.GetValue(returnParams) ?? 10);
    string returnSearch = (string)(returnParams.GetType().GetProperty("ReturnSearch")?.GetValue(returnParams) ?? "");

    var totalPages = pager.TotalPages > 0 ? pager.TotalPages : 1;
    if (currentPage > totalPages) currentPage = totalPages;

    var pagesToShow = new List<int>();
    void AddP(int p) { if (p >= 1 && p <= totalPages && !pagesToShow.Contains(p)) pagesToShow.Add(p); }
    AddP(1); AddP(2);
    for (int p = currentPage - 1; p <= currentPage + 1; p++) AddP(p);
    AddP(totalPages - 1); AddP(totalPages);
    pagesToShow.Sort();
}

@section Styles {
    <link rel="stylesheet" href="~/css/lista-comprobante.css" asp-append-version="true" />
}

<section class="ln-banner">
    <h1>Lista de comprobantes</h1>
</section>

<!-- Contenedor principal con flex para paginación pegada al footer -->
<div class="conteiner cc-content-wrapper">

    <div class="search-container">
        <div class="search position-relative">
            <input type="text"
                   class="form-control rounded-xl pr-5"
                   id="search"
                   name="search"
                   value="@search"
                   placeholder="número de comprobante, código de envío o nombre de cliente.">

            <button type="button"
                    id="btnSearch"
                    class="search-icon-btn">
                <i class="fas fa-search"></i>
            </button>
        </div>
    </div>

    <!-- BOTÓN VOLVER: regresa a la pantalla de correlativo de comprobante -->
    <div class="d-flex justify-content-end mb-2">
        <a id="btnVolver" class="btn-Volver">
            <i class="fas fa-arrow-left mr-1"></i>
            Volver
        </a>
    </div>

    <!-- TABLA-->
        <div class="card lista-marchamos-card">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table tabla-marchamos mb-0"
       id="tablaListaComprobante"
       class="tabla-marchamos"
       data-pdf-url='@Url.Action("Index", "ComprobantePDF")'
       data-correlativo-id="@Model.CorrelativoId"
       data-return-page="@returnPage"
       data-return-size="@returnSize"
       data-return-search="@returnSearch">
                        <thead>
                            <tr>
                                <th class="FechaRegistre">Fecha registro</th>
                                <th class="NumeroComprobante">N° comprobante</th>
                                <th class="NumeroEnvio">N° de envío</th>
                                <th class="Estado">Estado</th>
                                <th class="Cliente">Cliente</th>
                                <th class="Producto">Producto</th>
                                <th class="FechaImpresion">Fecha Impresión</th>
                                <th class="IconoImpresion sticky-actions">Opciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.Items != null && Model.Items.Count > 0)
                            {
                               @foreach (var item in Model.Items)
                            {
                    var puedeImprimir = !string.IsNullOrWhiteSpace(item.NumeroEnvio);
                    var hasEnvio = !string.IsNullOrWhiteSpace(item.NumeroEnvio);
                    var isVoided = string.Equals(item.EstadoCode, "VOIDED", StringComparison.OrdinalIgnoreCase);

                    <tr data-id="@item.Id"
                        data-envio="@item.NumeroEnvio"
                        data-numero="@item.NumeroComprobante"
                        class="@(isVoided ? "row-voided" : "")"
                        title="@(isVoided ? "Anulado" : "")">
                        <td class="FechaRegistre">
                            @item.FechaRegistro.ToString("dd/MM/yyyy HH:mm")
                        </td>
                        <td class="NumeroComprobante">
                            @item.NumeroComprobante
                        </td>
                        <td class="NumeroEnvio">
                            @(string.IsNullOrWhiteSpace(item.NumeroEnvio)
                                ? ""
                                : item.NumeroEnvio)
                        </td>
                        <td class="Estado">
                            @item.Estado
                        </td>
                        <td class="Cliente">
                            @item.Cliente
                        </td>
                        <td class="Producto">
                            @item.Producto
                        </td>
                        <td class="FechaImpresion">
                            @(item.FechaImpresion.HasValue
                                ? item.FechaImpresion.Value.ToString("dd/MM/yyyy HH:mm")
                                : "")
                        </td>
                        <td class="col-opciones opciones-cell sticky-actions">
                            <button type="button"
                                class="btn-icon btn-annul @(hasEnvio ? "" : "btn-disabled")"
                                title="Impresión de comprobante"
                                @(hasEnvio ? "" : "disabled")>
                            <i class="fas fa-print"></i>
                        </button>
                        </td>
                    </tr>
                    }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="8" class="text-center">
                                        No se encontraron comprobantes para este rango.
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>

                </div>
            </div>
        </div>



    <!-- Paginación -->
    <div class="conteiner-paginacion">
        <div class="lc-pagination-controls conteiner-paginacion">
            @if (totalPages > 1)
            {
                <div class="lc-pagination-row d-flex justify-content-between align-items-center flex-wrap">
                    <div class="lc-pagination-spacer"></div>

                    <div class="lc-pagination lc-pagination-nav d-flex justify-content-center align-items-center">
                        <!-- Anterior -->
                        <a class="page-nav @(currentPage <= 1 ? "disabled" : "")"
                           href="@(currentPage <= 1 ? "javascript:void(0)" : BuildPageUrl(currentPage - 1, sizeVal, search, Model.CorrelativoId, returnPage, returnSize, returnSearch))"
                           title="Anterior" aria-label="Página anterior">
                            <i class="fas fa-angle-left"></i>
                        </a>

                        <!-- Números de página -->
                        @for (int i = 0; i < pagesToShow.Count; i++)
                        {
                            var p = pagesToShow[i];
                            var prev = i > 0 ? pagesToShow[i - 1] : (int?)null;
                            if (prev.HasValue && p - prev.Value > 1)
                            {
                                <span class="ellipsis">…</span>
                            }

                            var isCurrent = (p == currentPage);
                            <a class="page-num @(isCurrent ? "current" : "")"
                               href="@(isCurrent ? "javascript:void(0)" : BuildPageUrl(p, sizeVal, search, Model.CorrelativoId, returnPage, returnSize, returnSearch))"
                               aria-current="@(isCurrent ? "page" : null)">
                                @p
                            </a>
                        }

                        <!-- Siguiente -->
                        <a class="page-nav @(currentPage >= totalPages ? "disabled" : "")"
                           href="@(currentPage >= totalPages ? "javascript:void(0)" : BuildPageUrl(currentPage + 1, sizeVal, search, Model.CorrelativoId, returnPage, returnSize, returnSearch))"
                           title="Siguiente" aria-label="Página siguiente">
                            <i class="fas fa-angle-right"></i>
                        </a>
                    </div>

                    <!-- Select de registros -->
                    <div class="lc-page-size-selector d-flex align-items-center">
                        <label for="pageSizeSelect" class="mb-0 mr-2 text-muted small">Registros:</label>
                        <select id="pageSizeSelect" class="form-control form-control-sm">
                            @{
                                int[] sizes = new[] { 10, 20, 30, 50 };
                                foreach (var s in sizes)
                                {
                                    <option value="@s" selected="@(sizeVal == s)">@s</option>
                                }
                            }
                        </select>
                    </div>
                </div>
            }
            else
            {
                <div class="d-flex justify-content-end">
                    <div class="lc-page-size-selector d-flex align-items-center">
                        <label for="pageSizeSelect" class="mb-0 mr-2 text-muted small">Registros:</label>
                        <select id="pageSizeSelect" class="form-control form-control-sm">
                            @{
                                int[] sizes = new[] { 10, 20, 30, 50 };
                                foreach (var s in sizes)
                                {
                                    <option value="@s" selected="@(sizeVal == s)">@s</option>
                                }
                            }
                        </select>
                    </div>
                </div>
            }
        </div>
    </div>

    <!-- ============================
     OVERLAY DE PREVISUALIZACIÓN / IMPRESIÓN DE COMPROBANTE
     ============================ -->
<div id="printOverlay" class="print-overlay">
    <div class="print-overlay-content">
        <div class="print-overlay-header">
            <span>Vista previa de comprobante</span>
            <button type="button" id="btnClosePrint" class="btn-close-print" title="Cerrar">
                &times;
            </button>
        </div>
        <div class="print-overlay-body">
            <iframe id="printIframe"
                    src=""
                    frameborder="0"
                    scrolling="auto"></iframe>
        </div>
    </div>
</div>





</div>

@section Scripts {
    <script>
    // URL base correcta hacia el ComprobantePDF
    const comprobantePdfBaseUrl = '@Url.Action("Index", "ComprobantePDF")';
</script>
    <script src="~/js/lista-comprobante.js" asp-append-version="true"></script>
}

@functions {
    public string BuildPageUrl(int page, int size, string search, int correlativoId, int returnPage = 1, int returnSize = 10, string returnSearch = "")
    {
        var q = System.Web.HttpUtility.ParseQueryString(string.Empty);
        q["page"] = page.ToString();
        q["size"] = size.ToString();
        if (!string.IsNullOrWhiteSpace(search)) q["search"] = search;
        if (correlativoId > 0) q["correlativoId"] = correlativoId.ToString();

        // Preservar parámetros de retorno
        q["returnPage"] = returnPage.ToString();
        q["returnSize"] = returnSize.ToString();
        q["returnSearch"] = returnSearch ?? "";

        // En esta vista el controlador es ListaComprobante
        return Url.Action("Index", "ListaComprobante") + "?" + q.ToString();
    }
}
